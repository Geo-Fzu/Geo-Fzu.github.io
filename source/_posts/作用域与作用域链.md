---
title: 作用域与作用域链
date: 2016-07-20 23:21:06
tags: [JavaScript, 概念, 作用域]
categories: tech
---

要深刻理解函数的作用域和作用域链，首先要掌握以下几个概念：

- **运行期上下文：**
  - 函数被执行时创建
  - 拥有一个自己的作用域链
  - 初始为当前运行函数 `[[scope]]` 属性（函数定义时被确定）所包含的对象
- **活动对象（Activation Object）：**
  - 由函数的运行期上下文创建
  - 在运行时可变
  - 初始时只有 arguments 属性，通过变量的初始化，包含了局部变量、命名参数、 this 等
- **执行环境：**
  - 分为全局执行环境和局部执行环境
  - 执行环境决定了变量或函数有权访问的其它数据
  - 每个执行环境都拥有一个`变量对象`
- **[[scope]] 属性：**
  - 函数对象都有一个内部属性 [[scope]]
  - 函数被创建后，函数 `[[scope]]` 属性会被创建此函数的作用域中可访问的数据对象填充，是所有父变量对象的层级链
  - `[[scope]]` 在函数被创建时**静态存储**，永远不会改变，直至销毁
- **作用域：**
  - 作用域是函数的内部属性，谈到作用域绕不开 function
  - 决定了哪些变量能被函数访问
- **作用域链：** - 与一个运行期上下文相关，用于标识符解析中变量查找 - 函数被调用时创建运行期上下文的作用域链，包含活动对象和函数内部的 `[[scope]]` 属性 - 作用域链本质上是一个指向变量对象的指针列表，它只引用但不实际包含变量对象
  <!--more-->

---

```javascript
var x = 10;
function foo() {
  var y = 20;
  function bar() {
    var z = 30;
    console.log(x + y + z);
  }
  bar();
}
foo();
```

我们分析以上代码中各层的`活动对象`，`函数的[[scope]]属性`以及`运行期的作用域链`：

1. ### 全局执行环境：

   - 变量对象 VO：

   ```javascript
       globalcontext.VO === Global = {
           x: 10,
           foo: function
       }
   ```

2. ### foo 被**创建**时：

   - foo 的 `[[scope]]` 属性：

   ```javascript
       foo.[[scope]] = [
           globalcontext.VO
       ]
   ```

3. ### foo 被**调用**时：

   - foo 的运行期上下文产生的活动对象：

   ```javascript
       fooContext.AO = {
           y: 20,
           bar: function
       }
   ```

   - foo **运行期上下文作用域链**：

   ```javascript
       fooContext.Scope = fonContext.AO + foo.[[scope]]
       //等同于
       fooContext.Scope = [
           fonContext.AO,
           globalContext.VO
       ]
   ```

4. ### bar 被**创建**时：

   - bar 的 `[[scope]]` 属性：

   ```javascript
       bar.[[scope]] = [
           fooContext.AO,
           globalcontext.VO
       ]
   ```

5. ### bar 被**调用**时：
   - bar 的运行期上下文产生的活动对象：
   ```javascript
   barContext.AO = {
     z: 30
   };
   ```
   - bar **运行期上下文作用域链**：
   ```javascript
       barContext.Scope = barContext.AO + bar.[[scope]]
       //等同于
       fooContext.Scope = [
           barContext.AO,
           fonContext.AO,
           globalContext.VO
       ]
   ```
